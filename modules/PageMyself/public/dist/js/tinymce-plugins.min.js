'use strict';

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

tinymce.PluginManager.add('pagemyself', function (editor, url) {
  /** @type {PageMyselfComponent} */
  const component = editor.pagemyselfComponent;
  const el = $(editor.targetElm);
  editor.ui.registry.addButton('pagemyself-save-text', {
    text: FramelixLang.get('__framelix_save__'),
    onAction: async function onAction() {
      Framelix.showProgressBar(1);
      const content = editor.getContent({
        format: 'raw'
      });
      await component.apiRequest('textEditorSaveText', {
        'id': el.attr('data-id'),
        'text': content
      });
      FramelixToast.success('__framelix_saved__');
      Framelix.showProgressBar(null);
      editor.initialContent = content;
      editor.destroy();
      component.enableTextEditor(el);
    }
  });
  editor.ui.registry.addButton('pagemyself-cancel-text', {
    tooltip: FramelixLang.get('__pagemyself_reset_text__'),
    icon: 'rotate-left',
    onAction: function onAction() {
      editor.setContent(editor.initialContent);
      editor.destroy();
      component.enableTextEditor(el);
    }
  });
  editor.ui.registry.addMenuButton('pagemyself-templates', {
    text: FramelixLang.get('__pagemyself_editor_templates__'),
    fetch: function fetch(callback) {
      const templates = TinymceTemplates.getTemplates();
      let options = [];

      for (let id in templates) {
        const row = templates[id];
        options.push({
          type: 'menuitem',
          text: FramelixLang.get('__pagemyself_editor_templates_type_' + id.toLowerCase() + '__'),
          onAction: async function onAction() {
            let replacements = {};
            let values = null;

            if (row.fields) {
              const modalContent = $('<div>');
              const form = new FramelixForm();

              for (let i in row.fields) {
                /** @type {FramelixFormField} */
                const field = row.fields[i];
                field.name = i.toString();
                form.addField(field);
              }

              form.addButton('accept', '__framelix_ok__', 'check', 'success');
              form.render();
              modalContent.append(form.container);
              const formModal = FramelixModal.show({
                bodyContent: modalContent,
                maxWidth: 900
              });
              let proceed = false;
              form.container.on('click', '.framelix-form-buttons button', async function (ev) {
                ev.stopPropagation();
                ev.stopImmediatePropagation();

                if ((await form.validate()) === true) {
                  proceed = true;
                  formModal.destroy();
                }
              });
              await formModal.destroyed;
              if (!proceed) return;
              values = form.getValues();

              if (values) {
                replacements = values;
              }
            }

            let html = await TinymceTemplates.getTemplateHtml(id, values, replacements);

            for (let search in replacements) {
              html = html.replace(new RegExp(FramelixStringUtils.escapeRegex('{' + search + '}'), 'ig'), replacements[search]);
            }

            editor.insertContent(html);
          }
        });
      }

      callback(options);
    }
  });
  editor.ui.registry.addMenuItem('block-settings', {
    icon: 'settings',
    text: FramelixLang.get('__pagemyself_editor_templates_settings__'),
    onAction: function onAction() {
      const node = editor.selection.getNode();
      if (!node) return;
      const colorPicker = node.closest('[data-color-picker]');

      if (colorPicker) {
        const colorPickerData = colorPicker.dataset.colorPicker.split(',');
        const form = new FramelixForm();

        for (let i in colorPickerData) {
          const row = colorPickerData[i].split('|');
          const field = new FramelixFormFieldColor();
          field.name = i;
          field.label = row[0];
          if (row[1] === 'css' && colorPicker.style[row[2]]) field.defaultValue = FramelixColorUtils.cssColorToHex(colorPicker.style[row[2]]);
          form.addField(field);
          field.container.on(FramelixFormField.EVENT_CHANGE_USER, function () {
            colorPicker.style[row[2]] = field.getValue();
          });
        }

        form.render();
        const modal = FramelixModal.show({
          bodyContent: form.container,
          maxWidth: 900
        });
      }
    }
  });
  editor.ui.registry.addContextMenu('image', {
    update: function update(element) {
      return !element.closest('[data-color-picker]') ? '' : 'block-settings';
    }
  });
  return {
    getMetadata: function getMetadata() {
      return {
        name: FramelixLang.get('__pagemyself_component_text_title__')
      };
    }
  };
});

class TinymceTemplates {
  /**
   * Get templates
   * @returns {Object<string, {html: string, title: string}>}
   */
  static getTemplates() {
    const defaultText = FramelixLang.get('__pagemyself_editor_templates_edit_text__');
    return {
      'alert': {
        'html': `<br/><div class="framelix-alert framelix-alert-customcolor" style="--color-custom-bg:{0}; --color-custom-text:{1};">${defaultText}</div><br/>`,
        'fields': [Object.assign(new FramelixFormFieldColor(), {
          'label': this.LABEL_COLOR_BG,
          'defaultValue': '#009dff',
          required: true
        }), Object.assign(new FramelixFormFieldColor(), {
          'label': this.LABEL_COLOR_TEXT,
          'defaultValue': '#fff',
          required: true
        })]
      },
      'buttonLink': {
        'html': `<a class="framelix-button framelix-button-customcolor" style="--color-custom-bg:{2}; --color-custom-text:{3};" href="{0}" target="_blank">{1}</a>`,
        'fields': [Object.assign(new FramelixFormFieldText(), {
          'label': 'URL',
          required: true
        }), Object.assign(new FramelixFormFieldText(), {
          'label': 'Text',
          required: true
        }), Object.assign(new FramelixFormFieldColor(), {
          'label': this.LABEL_COLOR_BG,
          'defaultValue': '#009dff',
          required: true
        }), Object.assign(new FramelixFormFieldColor(), {
          'label': this.LABEL_COLOR_TEXT,
          'defaultValue': '#fff',
          required: true
        })]
      },
      'jumpMark': {
        'html': `<div class="pagemyself-jump-mark mceNonEditable" data-id="jumpto-{1}"></div>`,
        'fields': [Object.assign(new FramelixFormFieldHtml(), {
          defaultValue: FramelixLang.get('__pagemyself_editor_templates_type_jumpmark_info__')
        }), Object.assign(new FramelixFormFieldText(), {
          'label': '__pagemyself_editor_templates_type_jumpmark__',
          required: true
        })]
      },
      'emailme': {
        'html': `<button class="framelix-button framelix-button-primary" onclick='{mailonclick}'>${FramelixLang.get('__pagemyself_editor_templates_type_emailme_sendmail__')}</button>`,
        'fields': [Object.assign(new FramelixFormFieldEmail(), {
          'label': '__pagemyself_editor_templates_type_emailme_email__',
          required: true
        }), Object.assign(new FramelixFormFieldText(), {
          'label': '__pagemyself_editor_templates_type_emailme_subject__'
        })]
      },
      'columns': {
        'html': ``,
        'fields': [Object.assign(new FramelixFormFieldNumber(), {
          'label': '__pagemyself_editor_templates_type_columns_number__',
          required: true,
          max: 5,
          defaultValue: 2
        })]
      }
    };
  }
  /**
   * Get template html to insert in tinymce editor
   * You can use this to ask user for some input or stuff like that that can't be handled with default fields
   * Manipulate template container to your needs
   * Do not bind events on this container, they will not be fired
   * @param {string} id The template id
   * @param {Object|null} formValues The form values, when your template has some values to enter
   * @param {Object} replacements An object with key value pairs where {key} is automatically replaced with the value before insert
   *  Add more key/value pairs if you need more replacements
   * @return {Promise<string>}
   */


  static async getTemplateHtml(id, formValues, replacements) {
    let html = this.getTemplates()[id].html;

    switch (id) {
      case 'emailme':
        const email = formValues[0];
        const subject = formValues[1];
        let mailto = 'mailto:' + email + '?subject=' + encodeURIComponent(subject);
        let mailonclick = 'FramelixModal.show({bodyContent: atob(' + JSON.stringify(btoa(FramelixLang.get('__pagemyself_editor_templates_type_emailme_sendmailnfo__', [email]))) + '), maxWidth:600}); window.open(atob(' + JSON.stringify(btoa(mailto)) + '));';
        replacements['mailonclick'] = mailonclick;
        break;

      case 'columns':
        const columns = parseInt(formValues[0]);
        const container = $(`<div class="pagemyself-columns" data-columns="${columns}"></div>`);

        for (let i = 1; i <= columns; i++) {
          container.append(`<div class="pagemyself-column" data-color-picker="column|css|backgroundColor">Your text here</div>`);
        }

        html = container.html();
        break;
    }

    return html;
  }

}

_defineProperty(TinymceTemplates, "LABEL_COLOR_BG", '__pagemyself_editor_templates_colorpicker_bg__');

_defineProperty(TinymceTemplates, "LABEL_COLOR_TEXT", '__pagemyself_editor_templates_colorpicker_text__');